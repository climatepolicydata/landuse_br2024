```{r}
library(tidyverse)
library(stringi)
library(readxl)
library(xlsx)
source("C:/Users/napcc/Dropbox (CPI)/EduardoMinsky/PARAMIM/landuse_br2024/AuxFolder/Dictionary_Sectors.R")
setwd("A:\\projects\\landuse_br2024\\SIOP\\Clean_Data")

siop_tratado <- read_rds('Siop_Tratado_2015_2023_05_24.rds') #258.437 registros

#Tabelas relacionais
grupo_despesa <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="grupo_despesa")
channel_landscape <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="channel_landscape")
sector_landscape <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="sector_landscape")
sector_landscape <- sector_landscape %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des_orig,"Latin-ASCII"))))
sector_landscape <- sector_landscape %>%select(acao_des_limpa,sector_landscape)%>% distinct(acao_des_limpa,.keep_all=TRUE) 
sector_landscape %>% view
####################################################
source_landscape <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="source_landscape")

source_landscape <- source_landscape%>%mutate(source_original = str_trim(str_to_lower(stri_trans_general(source_original,"Latin-ASCII"))))

instrument_landscape <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="instrument_landscape")

climate_use <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="climate_use")
climate_use <- climate_use %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
climate_use$acao_des_limpa
######################################################################
# Filtrando as observações que nao pagaram nada
siop_tratado <- siop_tratado %>% filter(Pago != 0)
# Eliminando grupo de despesas que nao queremos
grupo_despesa %>% filter(select != 1) %>% select(grupo_despesa) %>% as.vector()

siop_tratado <- siop_tratado %>% filter(grupo_de_despesa != "juros e encargos da divida" & grupo_de_despesa!= "amortizacao da divida" & grupo_de_despesa != "reserva de contingencia") #141.998 registros

# Filtrando as Unidades Orçamentárias baseado no channel landscape:
siop_tratado_unidade_orcamentaria <- siop_tratado %>% inner_join(channel_landscape %>% filter(!is.na(und_orc)) %>% select(und_orc)%>% unique, by= "und_orc") 

# Criando o que não entrou de unidade orçamentaria -> df_remainder_SIOP1
df_remainder_SIOP1 <- siop_tratado %>% anti_join(siop_tratado_unidade_orcamentaria %>% select(und_orc )%>% unique, by= "und_orc") 

################################################################## RODAR APENAS UMA VEZ ESTAS LINHAS ################################################################################################
#siop_tratado_unidade_orcamentaria %>% group_by(modalidade,und_orc)%>% unique%>% count()%>% write_csv2("Modalidade_UnidadeOrcamentaria_SIOP_2015_2023_CriadoEm05_04_2023.csv")
######################################################################################################################################################################################################
#Filtrar as ações que compoem o sector landscape
siop_tratado_unidade_orcamentaria_acao <- siop_tratado_unidade_orcamentaria %>% inner_join(sector_landscape %>% select(acao_des_limpa),by = c("acao" = "acao_des_limpa")) #10.922 registros
df_remainder_siop2 <- siop_tratado_unidade_orcamentaria %>% anti_join(sector_landscape %>% select(acao_des_limpa),by = c("acao" = "acao_des_limpa"))
df_remainder_siop2 %>% select(programa,acao,plano_orc)%>% view

sector_landscape %>% anti_join(siop_tratado_unidade_orcamentaria,by = c("acao_des_limpa" = "acao")) %>% view # Todas as ações foram pegas
###################################### RODAR APENAS UMA VEZ ESSA PARTE############################################
acao_plan_orc_count <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx",sheet = "acao_plan_orc_filter")
acao_plan_orc_count_unique <- acao_plan_orc_count %>% mutate(plano_orc_clean = str_trim(str_to_lower(stri_trans_general(plano_orc_clean,"Latin-ASCII")),side="both")) %>% select(plano_orc_clean)%>%unique

siop_tratado_unidade_orcamentaria_acao_plano_orc <- siop_tratado_unidade_orcamentaria_acao %>%  filter(Ano >= 2015 & Ano <= 2020) %>% inner_join(acao_plan_orc_count_unique,by = c("plano_orc"="plano_orc_clean")) 

acao_plan_orc_count_unique %>% anti_join(siop_tratado_unidade_orcamentaria_acao_plano_orc,by = c("plano_orc_clean"="plano_orc")) %>% view #Sobrou nada
```

```{r Metodologia 1}
# Esta metodologia é o padrao, antes de ser proposto os filtros de ajuste
adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") 
resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% filter(acao != "administracao da unidade")

folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")


folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") 

resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
# Valor total sem aplicar rio_marker: 23.382.689.848
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 
# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  


data_siop_final_landscape2

# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaUM <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2$value_original_currency %>% sum #22.491.876.433
data_siop_final_landscape2 %>% filter(acao == "pesquisa e desenvolvimento de tecnologias para a agropecuaria" & plano_orc == "pesquisa e desenvolvimento para geracao de ativos pre- tecnologicos, ativos tecnologicos e apoia a inovacao") %>% select(acao,plano_orc,value_original_currency) %>% select(value_original_currency) %>% sum
# O valor esta parecido com a nossa 1a comparacao

```

```{r Metodologia 2}
# Esta metodologia aplica o Filtro para Unidade Administrativa e Folha de pagamento
adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
filter(plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro") # Esta de acordo com o Ajuste 1

# A partir de agora, vamos "excluir" QUALQUER UNIDADE ADMINISTRATIVA DA ANALISE, visto que já filtramos os planos orcs e unidades orcs
# da ação unidade administrativa
resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio")




folha_pagamento %>% filter(acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade")%>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% select(und_orc,plano_orc) %>% unique

# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 15.385.472.486
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 
# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  



# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #14.494.659.071

# Alguns outros problemas dessa metodologia:
# Planos orcamentarios, como do INPE, foram embora
# Não há Administração da Unidade;Capacitação de Recursos Humanos no INPE
data_siop_final_landscape2 %>% filter(acao == "administracao da unidade") %>% select(plano_orc) %>% unique %>% view
```

```{r Metodologia 3 - Algumas soluções}
# Esta metodologia visa ter um match maior com a base publicada

adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
filter(plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro") # Esta de acordo com o Ajuste 1

# A PRIMEIRA MUDANÇA É AQUI. VAMOS EXCLUIR DO RESTO APENAS AS ADMINISTRAÇÕES DA UNIDADE QUE NÓS PEGAMOS

resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% anti_join(adm_unidades_filter)

# Mantem-se o resto como esta
# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio")



#AINDA TEREMOS O MESMO PROBLEMA AQUI DAS FOLHAS DE PAG.
folha_pagamento %>% filter(acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade")%>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% select(und_orc,plano_orc) %>% unique

# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 15.385.472.486
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 
# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  


data_siop_final_landscape2

# Aplicacao Rio Marker
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2$value_original_currency %>% sum #16.557.046.561

# Alguns outros problemas dessa metodologia:
# Planos orcamentarios, como do INPE, foram embora
# Não há Administração da Unidade;Capacitação de Recursos Humanos no INPE
data_siop_final_landscape2 %>% filter(acao == "administracao da unidade") %>% select(plano_orc) %>% unique %>% view
# Ja esta um pouco melhor
```

```{r Metodologia 4 - Outras soluções}
# Esta metodologia visa ter um match maior com a base publicada

adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
filter(plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro") # Esta de acordo com o Ajuste 1

# A PRIMEIRA MUDANÇA É AQUI. VAMOS EXCLUIR DO RESTO APENAS AS ADMINISTRAÇÕES DA UNIDADE QUE NÓS PEGAMOS

resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% anti_join(adm_unidades_filter)

# Mantem-se o resto como esta
# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio")



#AINDA TEREMOS O MESMO PROBLEMA AQUI DAS FOLHAS DE PAG.
folha_pagamento %>% filter(acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade")%>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% select(und_orc,plano_orc) %>% unique

# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao

#A OUTRA MUDANÇA É AQUI: Vamos eliminar apenas as folhas de pagamento certo 
resto2 <- resto %>% anti_join(folha_pagamento_certo)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 81.554.457.899 VALOR EXPLODE
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 
# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  


data_siop_final_landscape2

# Aplicacao Rio Marker
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2$value_original_currency %>% sum #80.307.319.118 VALOR EXPLODE

# Alguns outros problemas dessa metodologia:
# Planos orcamentarios, como do INPE, foram embora
# Não há Administração da Unidade;Capacitação de Recursos Humanos no INPE
data_siop_final_landscape2 %>% filter(acao == "administracao da unidade") %>% select(plano_orc) %>% unique %>% view

```

```{r Metodologia 5 - Ultima solucao explorada}
# Esta metodologia visa ter um match maior com a base publicada

adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")# A MUDANCA ESTA BEM AQUI!!!
# retirar a 2a parte do ajuste 1



# A PRIMEIRA MUDANÇA É AQUI. VAMOS EXCLUIR DO RESTO APENAS AS ADMINISTRAÇÕES DA UNIDADE QUE NÓS PEGAMOS

resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% anti_join(adm_unidades_filter)

# Mantem-se o resto como esta
# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio")




folha_pagamento %>% filter(acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade")%>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% select(und_orc,plano_orc) %>% unique

# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao

#A OUTRA MUDANÇA É AQUI: EXCLUIR TDAS AS FOLHAS DE PAGAMENTO
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 17.804.185.342
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 
# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  


data_siop_final_landscape2

# Aplicacao Rio Marker
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2$value_original_currency %>% sum #16.913.371.927

# Alguns outros problemas dessa metodologia:
# Planos orcamentarios, como do INPE, foram embora
# Não há Administração da Unidade;Capacitação de Recursos Humanos no INPE
data_siop_final_landscape2 %>% filter(acao == "administracao da unidade") %>% select(plano_orc) %>% unique %>% view
# Ja esta um pouco melhor
```

```{r Metodologia 6}
library(readxl)
data_siop_final_landscape2_metodologiaPadrao
asd <- data_siop_final_landscape2_metodologiaUM %>% mutate(key = str_c(plano_orc,acao,und_orc,sep = "_")) %>% anti_join(data_siop_final_landscape2_metodologiaPadrao%>% mutate(key = str_c(plano_orc,acao,und_orc,sep = "_"),by = "key")) %>% select(plano_orc,acao,und_orc,value_original_currency) %>% group_by(plano_orc,acao,und_orc) %>% summarise(SomaValue = sum(value_original_currency)) 



data_siop_final_landscape2_metodologiaUM %>% mutate(key = str_c(plano_orc,acao,und_orc,sep = "_")) %>% anti_join(data_siop_final_landscape2_metodologiaPadrao%>% mutate(key = str_c(plano_orc,acao,und_orc,sep = "_"),by = "key")) %>% select(plano_orc,acao,und_orc,value_original_currency) %>% group_by(plano_orc,acao) %>% summarise(SomaValue = sum(value_original_currency)) %>% view

my_data <- read_excel("A:\\projects\\landuse_br2024\\siop\\Agrupamento_Acao_PlanoOrc_Unida_rev_gcr_EMC.xlsx", sheet = "Tabela")
my_data<-my_data %>% slice(2:783)
my_data %>% select(`acao;plano_orc`)
a <- my_data  
b <- data_siop_final_landscape2_metodologiaUM  %>% mutate(`acao;plano_orc` = str_c(acao,plano_orc,sep = ";"))%>% select(acao,plano_orc,value_original_currency,`acao;plano_orc`)
b %>% group_by(acao,plano_orc,`acao;plano_orc`) %>% summarise(soma = sum(value_original_currency))
a %>% left_join(b %>% group_by(acao,plano_orc,`acao;plano_orc`) %>% summarise(soma = sum(value_original_currency)) ,by = "acao;plano_orc") %>% write.xlsx("ASD.xlsx")
b %>% filter(`acao;plano_orc`=="pessoal ativo da uniao;ativos civis da uniao") %>% select(und_orc) %>% unique
```

```{r Exemplo Final}

adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj"|
                                                                                                                                     und_orc=="ministerio da ciencia, tecnologia e inovacao - administracao direta")

# A partir de agora, vamos "excluir" QUALQUER UNIDADE ADMINISTRATIVA DA ANALISE, visto que já filtramos os planos orcs e unidades orcs
# da ação unidade administrativa
resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% anti_join(adm_unidades_filter)
adm_unidades_filter %>% filter(acao == "administracao da unidade") %>% filter(plano_orc=="administracao da unidade - inpa") %>% select(acao,plano_orc,und_orc) %>% view
# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio"|
               plano_orc=="auxilio-transporte - civis"|
               plano_orc=="auxilio-funeral e natalidade de civis"|
               plano_orc=="contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
               plano_orc=="ativos civis da uniao"|
               plano_orc=="pagamento de pessoal ativo da uniao"|
               plano_orc=="pessoal ativo da uniao")



folha_pagamento_certo %>% filter(acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais")%>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% select(und_orc,plano_orc,Pago) %>% unique

# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#25.278.657.252->tirando apenas as ações que foram retidas no ajuste 1
#23.359.253.988 -> tirando todas as ações de adm unidade apos ajuste 1

#Valor sem rio_marker 15.385.472.486
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 
# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  



# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #24.387.843.837
data_siop_final_landscape2_metodologiaPadrao %>% select(und_orc,acao,plano_orc) %>% unique %>% view
3.271.520.112,87
```

```{r Exemplo Final 2}

# Esta metodologia aplica o Filtro para Unidade Administrativa e Folha de pagamento
siop_tratado_unidade_orcamentaria_acao_plano_orc %>%  filter(acao == "pesquisa e desenvolvimento de tecnologias para a agropecuaria" & plano_orc=="pesquisa e desenvolvimento para geracao de ativos pre- tecnologicos, ativos tecnologicos e apoia a inovacao") %>% select(acao,plano_orc,Pago,und_orc,Ano) %>% select(Pago) %>% sum
  
  
  
  
  
  
adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
filter(plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro" ) # Esta de acordo com o Ajuste 1

# A partir de agora, vamos "excluir" QUALQUER UNIDADE ADMINISTRATIVA DA ANALISE, visto que já filtramos os planos orcs e unidades orcs
# da ação unidade administrativa
resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio")




folha_pagamento_certo %>% filter(acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade")%>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% select(und_orc,plano_orc) %>% unique

# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 15.385.472.486


ficou_fora_landscape<- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% anti_join(data_siop_final)
restante <- ficou_fora_landscape %>% filter((acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa")|
                                  (acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa - regra de ouro")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpa")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe - regra de ouro"))

data_siop_final2 <- rbind(restante,data_siop_final)

# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final2%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 


# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  



# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #14.601.369.288


meudado_automatizado <- data_siop_final_landscape2_metodologiaPadrao %>% select(acao,plano_orc,value_original_currency) %>% group_by(acao,plano_orc) %>% summarise(ValorSomado = sum(value_original_currency)) 
data_siop_final_landscape2_metodologiaPadrao %>% filter(acao == "fiscalizacao de atividades agropecuarias" & plano_orc=="desenvolvimento e monitoramento de sistemas de rastreabilidade agroalimentar") %>% view


meudado_automatizado <- meudado_automatizado%>% mutate(`acao;plano_orc` = str_c(acao,plano_orc,sep = ";"))%>% select(acao,plano_orc,ValorSomado,`acao;plano_orc`)


my_data <- read_excel("A:\\projects\\landuse_br2024\\siop\\Agrupamento_Acao_PlanoOrc_Unida_rev_gcr_EMC.xlsx", sheet = "Tabela")
my_data<-my_data %>% slice(2:783)
my_data <- my_data %>% group_by(`acao;plano_orc`) %>% summarise(SomaValorOriginalPub = sum(`Soma de  value_original`),
                                                     SomaValorOriginalTabelaRelacional = sum(SomaNominal)) %>% ungroup()


my_data %>% left_join(meudado_automatizado, by = "acao;plano_orc") %>% mutate(DifValorPub =SomaValorOriginalPub - ValorSomado,
                                                                              DifValorTabelaRelacional = SomaValorOriginalTabelaRelacional-ValorSomado) %>%  write.xlsx("ComparacaoPublicado_Ajustes.xlsx")
getwd()

meudado_automatizado %>% view
view(data_siop_final_landscape2_metodologiaPadrao %>% select(value_original_currency,acao,plano_orc,und_orc) %>% group_by(acao,plano_orc,und_orc) %>% summarise(somas = sum(value_original_currency)) )

siop_tratado_unidade_orcamentaria_acao_plano_orc%>% select(Pago,acao,plano_orc,und_orc) %>% group_by(acao,plano_orc,und_orc) %>% summarise(somas = sum(Pago)) %>% view
```

```{r BATE LINHA - Referente a metodologia do exemplo Final 2}
# Esta metodologia aplica o Filtro para Unidade Administrativa e Folha de pagamento
target <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "pesquisa e desenvolvimento de tecnologias para a agropecuaria" & plano_orc == "pesquisa e desenvolvimento para geracao de ativos pre- tecnologicos, ativos tecnologicos e apoia a inovacao")
target %>% select(acao,plano_orc,und_orc,Pago) %>% unique %>% view



adm_unidades_filter <- target %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
filter(plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro" ) # Esta de acordo com o Ajuste 1

# A partir de agora, vamos "excluir" QUALQUER UNIDADE ADMINISTRATIVA DA ANALISE, visto que já filtramos os planos orcs e unidades orcs
# da ação unidade administrativa
resto <- target%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- target %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio")


view(target %>% select(acao,plano_orc,und_orc,Pago) %>% group_by(acao,plano_orc,und_orc) %>% summarise(PAGOS = sum(Pago)))
# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
adm_unidades_filter %>% select(acao,plano_orc)
#Valor sem rio_marker 15.385.472.486


ficou_fora_landscape<- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% anti_join(data_siop_final)
restante <- ficou_fora_landscape %>% filter((acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa")|
                                  (acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa - regra de ouro")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpa")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe - regra de ouro"))
ficou_fora_landscape %>% filter(plano_orc == "administracao da sede") %>% select(acao,plano_orc,und_orc) %>% unique %>% view
data_siop_final2 <- rbind(restante,data_siop_final)

# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final2%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 


# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  



# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #14.601.369.288

meudado_automatizado %>% select(acao,plano_orc) %>% unique %>% view





meudado_automatizado <- data_siop_final_landscape2_metodologiaPadrao %>% select(acao,plano_orc,value_original_currency) %>% group_by(acao,plano_orc) %>% summarise(ValorSomado = sum(value_original_currency)) %>% ungroup() 

meudado_automatizado <- meudado_automatizado%>% mutate(`acao;plano_orc` = str_c(acao,plano_orc,sep = ";"))%>% select(acao,plano_orc,ValorSomado,`acao;plano_orc`)


my_data <- read_excel("A:\\projects\\landuse_br2024\\siop\\Agrupamento_Acao_PlanoOrc_Unida_rev_gcr_EMC.xlsx", sheet = "Tabela")
my_data<-my_data %>% slice(2:783)
my_data <- my_data %>% group_by(`acao;plano_orc`) %>% summarise(SomaValorOriginalPub = sum(`Soma de  value_original`),
                                                     SomaValorOriginalTabelaRelacional = sum(SomaNominal)) %>% ungroup()


my_data %>% left_join(meudado_automatizado, by = "acao;plano_orc") %>% mutate(DifValorPub =SomaValorOriginalPub - ValorSomado,
                                                                              DifValorTabelaRelacional = SomaValorOriginalTabelaRelacional-ValorSomado) %>%  write.xlsx("ComparacaoPublicado_Ajustes.xlsx")
getwd()

meudado_automatizado %>% view
view(data_siop_final_landscape2_metodologiaPadrao %>% select(value_original_currency,acao,plano_orc,und_orc) %>% group_by(acao,plano_orc,und_orc) %>% summarise(somas = sum(value_original_currency)) )

siop_tratado_unidade_orcamentaria_acao_plano_orc%>% select(Pago,acao,plano_orc,und_orc) %>% group_by(acao,plano_orc,und_orc) %>% summarise(somas = sum(Pago)) %>% view
```

```{r CRIACAO DADO FINAL}
# Esta metodologia aplica o Filtro para Unidade Administrativa e Folha de pagamento


adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
filter(plano_orc == "administracao da sede"| plano_orc == "administracao das unidades regionais"| plano_orc=="administracao das unidades regionais - regra de ouro" |plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro" | plano_orc == "capacitacao de servidores publicos federais do ibama" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim" |
         plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro" | plano_orc == "coronavirus (covid-19)" |
         plano_orc == "educacao ambiental" |plano_orc == "emenda individual"|
         plano_orc == "gestao administrativa da politica contra as mudancas do clima e de promocao da qualidade ambiental"|plano_orc == "gestao administrativa da politica da biodiversidade"|
         plano_orc == "gestao administrativa da politica das mudancas do clima e de florestas"|
         plano_orc == "gestao administrativa da politica de articulacao e cidadania ambiental"|
         plano_orc == "gestao administrativa da politica de desenvolvimento rural e extrativismo"|
         plano_orc == "gestao administrativa da politica de meio ambiente"|
         plano_orc == "gestao administrativa da politica de recursos hidricos e de qualidade ambiental"|
         plano_orc == "gestao administrativa da politica de relacoes internacionais"|
         plano_orc=="gestao administrativa da politica florestal e da biodiversidade"|
         plano_orc == "gestao administrativa da politica residuos solidos, ambientes urbanos e recursos hidricos"|
         plano_orc == "gestao de politicas de meio ambiente"|
         plano_orc == "manutencao e adaptacao de imoveis"|
         plano_orc == "manutencao e adaptacao de imoveis - regra de ouro"|
         plano_orc == "manutencao e modernizacao da infraestrutura fisica da sede e das unidades descentralizadas"|
         plano_orc == "modernizacao da estrutura de informatica do ibama"|
         plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente"|
         plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente - regra de ouro"|
         plano_orc == "outras despesas administrativas"|
         plano_orc == "outras despesas administrativas - regra de ouro"|
         plano_orc == "reuniao dos comites regionais"|
         plano_orc == "tecnologia da informacao"|
         plano_orc == "tecnologia da informacao - regra de ouro") # Esta de acordo com o Ajuste 1

# A partir de agora, vamos "excluir" QUALQUER UNIDADE ADMINISTRATIVA DA ANALISE, visto que já filtramos os planos orcs e unidades orcs
# da ação unidade administrativa
resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                   acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                   acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                   acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                   acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                   acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                   acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                   acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                     acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais")

# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                             und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                             und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                               und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
             plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
             plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
             plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
             plano_orc == "auxilio-alimentacao de civis"|plano_orc == "auxilio-transporte - civis"|
             plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
             plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio"|
               plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas - regra de ouro"|
               plano_orc == "ativos civis da uniao"|
               plano_orc == "auxilio-funeral e natalidade de civis"|
               plano_orc == "assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
               plano_orc == "auxilio-funeral e natalidade de civis"|
               plano_orc == "auxilio-transporte de civis"|
               plano_orc == "regra de ouro: assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
               plano_orc == "regra de ouro: auxilio-alimentacao de civis"|
               plano_orc == "regra de ouro: auxilio-funeral e natalidade de civis"|
               plano_orc == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|plano_orc == "pagamento de pessoal ativo da uniao"|plano_orc == "ativos civis da uniao"|plano_orc == "pessoal ativo da uniao")




# Observa-se que:
# Sem observacao para a acao auxilio-transporte aos servidores civis, empregados e militares  
# sem observacao para a acao beneficios assistenciais decorrentes do auxilio-funeral e natalidade
# sem observacao para a acao contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais
# sem observacao para a acao ativos civis da uniao
# Sem observacao para a acao pagamento de pessoal ativo da uniao
# sem observacao para a acao pessoal ativo da uniao
resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 23.382.689.848


ficou_fora_landscape<- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% anti_join(data_siop_final)
restante <- ficou_fora_landscape %>% filter((acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa")|
                                  (acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa - regra de ouro")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpa")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe")|
                                  (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe - regra de ouro"))

data_siop_final2 <- rbind(restante,data_siop_final)

# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final2%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 


# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 
  



# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #22.598.586.650





meudado_automatizado <- data_siop_final_landscape2_metodologiaPadrao %>% select(acao,plano_orc,value_original_currency) %>% group_by(acao,plano_orc) %>% summarise(ValorSomado = sum(value_original_currency)) 



meudado_automatizado <- meudado_automatizado%>% mutate(`acao;plano_orc` = str_c(acao,plano_orc,sep = ";"))%>% select(acao,plano_orc,ValorSomado,`acao;plano_orc`)


my_data <- read_excel("A:\\projects\\landuse_br2024\\siop\\Agrupamento_Acao_PlanoOrc_Unida_rev_gcr_EMC.xlsx", sheet = "Tabela")
my_data<-my_data %>% slice(2:783)
my_data <- my_data %>% group_by(`acao;plano_orc`) %>% summarise(SomaValorOriginalPub = sum(`Soma de  value_original`),
                                                     SomaValorOriginalTabelaRelacional = sum(SomaNominal)) %>% ungroup()


my_data %>% left_join(meudado_automatizado, by = "acao;plano_orc") %>% mutate(DifValorPub =SomaValorOriginalPub - ValorSomado,
                                                                              DifValorTabelaRelacional = SomaValorOriginalTabelaRelacional-ValorSomado) %>%  write.xlsx("ComparacaoPublicado_Ajustes_VERSAO3.xlsx")


meudado_automatizado %>% anti_join(my_data, by = "acao;plano_orc") %>% ungroup %>%  write.xlsx("FORA.xlsx")


```

#############################################################
A partir daqui serão criados codigos de exploracao para o siop expansão (21 23)
```{r Exploracao das acoes da tabela relacional que nao foram pegas}
# Acoes da tabela relacional q nao tiveram match com o siop 21 23
library(tidyverse)
library(stringi)
library(readxl)
library(xlsx)

setwd("A:\\projects\\landuse_br2024\\SIOP\\Clean_Data")
siop_tratado <- read_rds('Siop_Tratado_2015_2023_05_24.rds') #258.437 registros
acoes_relacional_fora <- read_excel("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\AcoesDeForaFiltro3_16_05_2024.xlsx")
acoes_relacional_fora$acao_des_limpa
siop_tratado %>% inner_join(acoes_relacional_fora %>% select(acao_des_limpa),by = c("acao"="acao_des_limpa")) %>% select(acao,Ano,Pago) %>% unique %>% write.xlsx("AcoesDeForaFiltro3ExplicacaoFinal.xlsx")
```
```{r Explorando os planos orcamentarios da tabela relacional que nao foram pegos}
library(tidyverse)
library(stringi)
library(readxl)
library(xlsx)
source("C:/Users/napcc/Dropbox (CPI)/EduardoMinsky/PARAMIM/landuse_br2024/AuxFolder/Dictionary_Sectors.R")
grupo_despesa <- read_excel("A:/projects/landuse_br2024/SIOP/12_siop_relational_tables.xlsx", sheet="grupo_despesa")
siop_tratado <- read_rds('A:\\projects\\landuse_br2024\\SIOP\\Clean_Data\\Siop_Tratado_2015_2023_05_24.rds') #258.437 registros
planos_orcs_de_fora<- read_excel("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\PlanosFora_16_05_2024.xlsx")

siop_tratado %>% inner_join(planos_orcs_de_fora ,by = c("plano_orc"="plano_orc_clean")) %>% select(acao,plano_orc,Ano,Pago) %>% unique %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\PlanosForaExplicacaoFinal_16_05_2024.xlsx")


siop_tratado_ano <- siop_tratado %>% filter(Pago != 0)
siop_tratado_ano <- siop_tratado_ano%>%  filter(Ano >= 2015 & Ano <= 2023) 

# 2.1 Filter Grupo Despesa
grupo_despesa %>% filter(select != 1) %>% select(grupo_despesa) %>% as.vector()
siop_tratado_ano <- siop_tratado_ano %>% filter(grupo_de_despesa != "juros e encargos da divida" & grupo_de_despesa!= "amortizacao da divida" & grupo_de_despesa != "reserva de contingencia") #141.998 registros
siop_tratado_ano %>% filter(acao == "desenvolvimento e aprimoramento dos modelos do sistema terrestre") %>% select(und_orc,acao,plano_orc,Ano,Pago) %>% view

```

```{r Criação do SIOP expansão sem atualizacao da tabela relacional}
library(tidyverse)
library(stringi)
library(readxl)
library(xlsx)


siop_tratado <- read_rds('A:\\projects\\landuse_br2024\\siop\\Clean_Data\\Siop_Tratado_2015_2023_05_24.rds') #258.437 registros

#Tabelas relacionais
grupo_despesa <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="grupo_despesa")
channel_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="channel_landscape")
sector_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="sector_landscape")
sector_landscape <- sector_landscape %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des_orig,"Latin-ASCII"))))
sector_landscape <- sector_landscape %>%select(acao_des_limpa,sector_landscape)%>% distinct(acao_des_limpa,.keep_all=TRUE) 
beneficiary_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="beneficiary_landscape")
beneficiary_landscape <- beneficiary_landscape%>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
beneficiary_landscape <- beneficiary_landscape %>% select(acao_des_limpa,beneficiary_landscape)
####################################################
source_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="source_landscape")

source_landscape <- source_landscape%>%mutate(source_original = str_trim(str_to_lower(stri_trans_general(source_original,"Latin-ASCII"))))

instrument_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="instrument_landscape")

climate_use <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="climate_use")
climate_use <- climate_use %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))

acao_plan_orc_count <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx",sheet = "acao_plan_orc_filter")
acao_plan_orc_count_unique <- acao_plan_orc_count %>% mutate(plano_orc_clean = str_trim(str_to_lower(stri_trans_general(plano_orc_clean,"Latin-ASCII")),side="both")) %>% select(plano_orc_clean)%>%unique
######################################################################
# Filtrando as observações que nao pagaram nada e filtro para ano
siop_tratado_ano <- siop_tratado %>% filter(Pago != 0)
siop_tratado_ano <- siop_tratado_ano%>%  filter(Ano >= 2021 & Ano <= 2023) 

# 2.1 Filter Grupo Despesa
grupo_despesa %>% filter(select != 1) %>% select(grupo_despesa) %>% as.vector()
siop_tratado_ano <- siop_tratado_ano %>% filter(grupo_de_despesa != "juros e encargos da divida" & grupo_de_despesa!= "amortizacao da divida" & grupo_de_despesa != "reserva de contingencia") #141.998 registros

# 2.3 Filtro de unidade orçamentária baseado na sheet channel landscape:
siop_tratado_unidade_orcamentaria <- siop_tratado_ano %>% inner_join(channel_landscape %>% filter(!is.na(und_orc)) %>% select(und_orc)%>% unique, by= "und_orc") 
channel_landscape %>% filter(!is.na(und_orc)) %>% select(und_orc) %>% anti_join(siop_tratado_ano, by= "und_orc") %>% view

# Pelo anti Join podemos ver que a unidade orçamentaria secretaria especial de agricultura familiar e do desenvolvimento agrario
# nao existe para os anos de 21 até 2023

# 2.3 Criando o primeiro Remainder:
df_remainder_SIOP1 <- siop_tratado_ano %>% anti_join(siop_tratado_unidade_orcamentaria %>% select(und_orc )%>% unique, by= "und_orc")

#df_remainder_SIOP1 %>% select(und_orc) %>% unique  %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\UnidadesOrcamentarias_2021_2023_Fora.xlsx")

#3.1 Seleção Setorial: É baseado nas ações
siop_tratado_unidade_orcamentaria_acao <- siop_tratado_unidade_orcamentaria %>% inner_join(sector_landscape %>% select(acao_des_limpa),by = c("acao" = "acao_des_limpa")) 
sector_landscape%>% select(acao_des_limpa) %>% anti_join(siop_tratado_unidade_orcamentaria,by =c( "acao_des_limpa" ="acao" ) )

# Tivemos ações da tabela relacional que nao tiveram match pois essas ações para os anos de 21 ate 23 tiveram valor pago de ZERO ou Acoes que nao existem
# para os anos em questao
# Esta explicacao encontra-se na pasta ExploracoesDados
#3.1 Criando o Remainder 2
df_remainder_siop2 <- siop_tratado_unidade_orcamentaria %>% anti_join(siop_tratado_unidade_orcamentaria_acao %>% select(acao),by = "acao" )
#df_remainder_siop2 %>% select(acao,plano_orc,und_orc) %>% unique %>%  write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\Acoes_2021_2023_Fora.xlsx")

# 3.2: Fitro de Planos Orcamentários
siop_tratado_unidade_orcamentaria_acao_plano_orc <- siop_tratado_unidade_orcamentaria_acao  %>% inner_join(acao_plan_orc_count_unique,by = c("plano_orc"="plano_orc_clean")) 

#acao_plan_orc_count_unique %>% anti_join(siop_tratado_unidade_orcamentaria_acao,by = c("plano_orc_clean" = "plano_orc")) %>% unique %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\Planos_orcDeForaFiltro3.2.xlsx")

# 3.2: Criando o Remainder Tres:
df_remainder_siop3 <- siop_tratado_unidade_orcamentaria_acao%>% anti_join(siop_tratado_unidade_orcamentaria_acao_plano_orc,by = "plano_orc")

#df_remainder_siop3 %>% select(plano_orc,acao,und_orc) %>% unique %>%  write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\Planos_orc_2021_2023_Fora.xlsx")


siop_tratado_unidade_orcamentaria_acao_plano_orc$Pago %>% sum


######################################################################################
acao_plan_orc_count_unique %>% anti_join(siop_tratado_unidade_orcamentaria_acao_plano_orc,by = c("plano_orc_clean"="plano_orc")) %>% view 

adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
  filter(plano_orc == "administracao da sede"| plano_orc == "administracao das unidades regionais"| plano_orc=="administracao das unidades regionais - regra de ouro" |plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro" | plano_orc == "capacitacao de servidores publicos federais do ibama" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim" |
           plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro" | plano_orc == "coronavirus (covid-19)" |
           plano_orc == "educacao ambiental" |plano_orc == "emenda individual"|
           plano_orc == "gestao administrativa da politica contra as mudancas do clima e de promocao da qualidade ambiental"|plano_orc == "gestao administrativa da politica da biodiversidade"|
           plano_orc == "gestao administrativa da politica das mudancas do clima e de florestas"|
           plano_orc == "gestao administrativa da politica de articulacao e cidadania ambiental"|
           plano_orc == "gestao administrativa da politica de desenvolvimento rural e extrativismo"|
           plano_orc == "gestao administrativa da politica de meio ambiente"|
           plano_orc == "gestao administrativa da politica de recursos hidricos e de qualidade ambiental"|
           plano_orc == "gestao administrativa da politica de relacoes internacionais"|
           plano_orc=="gestao administrativa da politica florestal e da biodiversidade"|
           plano_orc == "gestao administrativa da politica residuos solidos, ambientes urbanos e recursos hidricos"|
           plano_orc == "gestao de politicas de meio ambiente"|
           plano_orc == "manutencao e adaptacao de imoveis"|
           plano_orc == "manutencao e adaptacao de imoveis - regra de ouro"|
           plano_orc == "manutencao e modernizacao da infraestrutura fisica da sede e das unidades descentralizadas"|
           plano_orc == "modernizacao da estrutura de informatica do ibama"|
           plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente"|
           plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente - regra de ouro"|
           plano_orc == "outras despesas administrativas"|
           plano_orc == "outras despesas administrativas - regra de ouro"|
           plano_orc == "reuniao dos comites regionais"|
           plano_orc == "tecnologia da informacao"|
           plano_orc == "tecnologia da informacao - regra de ouro") # Esta de acordo com o Ajuste 1




resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                                      acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                                      acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                                      acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                                      acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                                      acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                                      acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                                      acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                                      acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                      acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais")
# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                                                       und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                                                       und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                                                       und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                                                                                                                                  plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                                                                                                                                                  plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "auxilio-alimentacao de civis"|plano_orc == "auxilio-transporte - civis"|
                                                                                                                                                  plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio"|
                                                                                                                                                  plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas - regra de ouro"|
                                                                                                                                                  plano_orc == "ativos civis da uniao"|
                                                                                                                                                  plano_orc == "auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "auxilio-transporte de civis"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "regra de ouro: auxilio-alimentacao de civis"|
                                                                                                                                                  plano_orc == "regra de ouro: auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|plano_orc == "pagamento de pessoal ativo da uniao"|plano_orc == "ativos civis da uniao"|plano_orc == "pessoal ativo da uniao")



resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 23.549.526.033  


ficou_fora_landscape<- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% anti_join(data_siop_final)
restante <- ficou_fora_landscape %>% filter((acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa")|
                                              (acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa - regra de ouro")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpa")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe - regra de ouro"))

data_siop_final2 <- rbind(restante,data_siop_final)

# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final2%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 


# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 


# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #23.562.480.565
data_siop_final_landscape2_metodologiaPadrao %>% select(sector_landscape) %>% unique %>% print
# Pequena alteração nas classes dos dados para padronizar e Ajustar sectors faltantes
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2_metodologiaPadrao %>% mutate(channel_landscape = case_when(channel_landscape == "Civil society organizations" ~ "Civil society organization",
                                                                                      channel_landscape == "Financial Institutions"  ~"Financial Institution",
                                                                                      .default = channel_landscape),
                                                        origin_private_public = case_when(origin_private_public == "Other"~"Others",
                                                                                          .default = origin_private_public),
                                                        origin_domestic_international = case_when(origin_domestic_international == "Domestic" ~"National",
                                                                                                  .default =origin_domestic_international )) 



data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2_metodologiaPadrao %>% mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "servico florestal brasileiro - sfb",
                                                                                   true = "Forest",false = sector_landscape)) %>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "ministerio da ciencia, tecnologia e inovacao - administracao direta",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "fundacao nacional do indio - funai",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "ministerio do meio ambiente e mudanca do clima - administracao direta",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto chico mendes de conservacao da biodiversidade",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "apoio ao desenvolvimento de agricultura de baixa emissao de carbono - abc" & und_orc == "ministerio da agricultura e pecuaria - administracao direta",
                                    true = "Crop",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao das medidas de ordenamento do uso de recursos pesqueiros" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Cattle",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao de periculosidade e controle de produtos, substancias quimicas e residuos perigosos" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao dos estoques e do potencial sustentavel dos recursos pesqueiros" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "controle ambiental de produtos, substancias, residuos e atividades potencialmente poluidoras" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do veiculo lancador de microssatelites vlm-1",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do satelite sino-brasileiro cbers-4a",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento de satelites cientificos",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do satelite sino-brasileiro cbers-4a - regra de ouro",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento dos satelites da serie amazonia",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de foguetes suborbitais e de veiculos lancadores de satelites" & und_orc == "agencia espacial brasileira",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de foguetes suborbitais e de veiculos lancadores de satelites, com a infraestrutura associada" & und_orc == "agencia espacial brasileira",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de satelites" & plano_orc == "desenvolvimento dos satelites da serie amazonia",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de satelites" & plano_orc == "desenvolvimento dos satelites sino-brasileiros cbers-4",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "monitoramento hidroambiental nos reservatorios do dnocs" & und_orc == "departamento nacional de obras contra as secas - dnocs",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "monitoramento, avaliacao e controle de substancias, produtos quimicos e biologicos e de atividades potencialmente poluidoras e utilizadoras de recursos ambientais" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
mutate(sector_landscape = if_else(acao == "pesquisa e desenvolvimento no setor aeroespacial" & und_orc == "comando da aeronautica",
                                  true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "pesquisa e desenvolvimento no setor aeroespacial" & und_orc == "fundo aeronautico",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "regulacao e fiscalizacao dos usos de recursos hidricos, dos servicos de irrigacao e aducao de agua bruta e da seguranca de barragens" & und_orc == "agencia nacional de aguas e saneamento basico - ana",
                                    true = "Multi-sector",false = sector_landscape))  %>% 
  mutate(sector_landscape=case_when(sector_landscape=="Agriculture" ~"Crop",
                                    .default = sector_landscape))
  


data_siop_final_landscape2_metodologiaPadrao_final<- data_siop_final_landscape2_metodologiaPadrao %>% left_join(beneficiary_landscape %>% distinct(acao_des_limpa,.keep_all = T) ,by=c("acao"="acao_des_limpa")) %>% 
  mutate(beneficiary_landscape = case_when(acao == "regularizacao da estrutura fundiaria na area de abrangencia da lei 11.952, de 2009"~"Smallholders",
                                           acao == "desenvolvimento economico e social dos produtores rurais"~"Rural Producers",
                                           acao == "abastecimento publico de agua em comunidades ribeirinhas dos rios sao francisco, do parnaiba, do itapecuru e do mearim. - agua para todos"~"Indigenous Peoples, Traditional Populations and Other Local Communities",
                                           acao == "manutencao de contrato de gestao com organizacoes sociais (lei nº 9.637, de 15 de maio de 1998)"~"Not Specified",
                                           acao == "gestao ambientalmente adequada de substancias quimicas"~"Not Specified",
                                           .default = beneficiary_landscape)) %>% 
  mutate(beneficiary_original = "-",
         beneficiary_public_private="-",
         localization_original = localizador,region = regiao,uf = uf,municipality=municipio,subactivity_landscape="-")
  
  


data_siop_final_landscape2_metodologiaPadrao_final$value_original_currency %>% sum
23.562.480.565
#Fazendo Deflacao
ibge_ipca <- read_excel("A:\\macro\\IPCA\\cleanData/ipca_ibge_cl.xlsx")
ibge_ipca <- ibge_ipca %>% 
  dplyr::mutate(variacao_doze_meses = suppressWarnings(as.numeric(variacao_doze_meses)))
deflator_automatico <- function(ano_ini, ano_fim, anos, base) {
  
  # Defina o seu projeto no Google Cloud, é importante criar o projeto e colar o id no "set_billing_id". Fora isso, nao funcionarah
  # Existe um bug no datalake da Base dos Dados que não permite o download direto.
  # set_billing_id("scenic-notch-360215")
  # 
  # # criacao do data frame direto da base de dados
  # serie_basedosdados <- basedosdados::bdplyr("br_ibge_ipca.mes_brasil") %>% bd_collect()
  
  serie_basedosdados <- base
  
  # selecao e filtros de valores de interesse ao calculo, queremos sempre a variacao anual, por isso o mes == 12
  serie_filtrada <- serie_basedosdados %>% 
    select(ano, mes, variacao_doze_meses) %>% 
    dplyr::filter(mes == 12,ano >= ano_ini & ano <= ano_fim ) %>% 
    dplyr::arrange(desc(ano))
  
  indice = 1
  
  #criacao do data frame para o deflator
  for (l in anos) {
    # chamei novamente a base feita pela funcao do api, pois a base precisa ser percorrida ano a ano e
    # se nao criarmos essa tabela, a tabela a ser percorrida novamente terá sempre o ano inicial como observacao
    tabela <- serie_filtrada 
    
    tabela <- tabela %>% 
      dplyr::filter(ano == l)
    
    if (l == ano_fim) {
      tabela <- tabela %>%  dplyr::mutate(deflator = indice)
      tabela_final <- tabela
      indice_ano_anterior = indice * (1+ (tabela$variacao_doze_meses/100))
    } else {
      tabela <- tabela %>% dplyr::mutate(deflator = indice_ano_anterior)
      
      tabela_final <- rbind(tabela_final, tabela)
      indice_ano_anterior = indice_ano_anterior * (1 + (tabela$variacao_doze_meses/100))
    }
  }
  tabela_final <- tabela_final %>% 
    select(ano, deflator) %>%
    dplyr::rename(year = ano) %>% 
    dplyr::arrange(year)
  return(tabela_final)
}

ano_ini = 2015
ano_fim = 2023
anos = seq(ano_fim,ano_ini, -1)
teste <- deflator_automatico(ano_ini, ano_fim, anos,ibge_ipca)
base_select_deflator <- data_siop_final_landscape2_metodologiaPadrao_final %>% 
  left_join(teste, by= "year")%>%
  dplyr::mutate(value_brl_deflated = value_original_currency * deflator)
base_select_deflator$value_brl_deflated %>% sum
# Fazendo a dolarizacao
coleta_dados_sgs = function(series,datainicial="01/01/2012", datafinal = format(Sys.time(), "%d/%m/%Y")){
  #Argumentos: vetor de séries, datainicial que pode ser manualmente alterada e datafinal que automaticamente usa a data de hoje
  #Cria estrutura de repetição para percorrer vetor com códigos de séries e depois juntar todas em um único dataframe
  for (i in 1:length(series)){
    dados = read.csv(url(paste("http://api.bcb.gov.br/dados/serie/bcdata.sgs.",series[i],"/dados?formato=csv&dataInicial=",datainicial,"&dataFinal=",datafinal,sep="")),sep=";")
    dados[,-1] = as.numeric(gsub(",",".",dados[,-1])) #As colunas do dataframe em objetos numéricos exceto a da data
    nome_coluna = series[i] #Nomeia cada coluna do dataframe com o código da série
    colnames(dados) = c('data', nome_coluna)
    nome_arquivo = paste("dados", i, sep = "") #Nomeia os vários arquivos intermediários que são criados com cada série
    assign(nome_arquivo, dados)
    
    if(i==1)
      base = dados1 #Primeira repetição cria o dataframe
    else
      base = merge(base, dados, by = "data", all = T) #Demais repetições agregam colunas ao dataframe criado
    print(paste(i, length(series), sep = '/')) #Printa o progresso da repetição
  }
  
  base$data = as.Date(base$data, "%d/%m/%Y")
  base$ano = as.integer(format(base$data,"%Y"))#Transforma coluna de data no formato de data
  base = base[order(base$data),] #Ordena o dataframe de acordo com a data
  
  base <- base %>% select(ano, `3694`)
  base <- base %>% dplyr::rename(c(year = ano, cambio = `3694`))
  return(base)
}
cambio_sgs = coleta_dados_sgs(3694) 
tabela_cambio <-cambio_sgs %>% 
  dplyr::filter(year >= 2015 & year <= 2023)

base_select_deflator = base_select_deflator %>% 
  left_join(tabela_cambio,by='year') %>% 
  dplyr::mutate(value_usd = value_brl_deflated/cambio)

# Finalizando e salvando
base_select_deflator<- base_select_deflator %>% select(id_original,data_source,year,project_name,project_description,source_original,
                                source_finance_landscape,origin_domestic_international,origin_private_public,
                                value_original_currency,original_currency,value_brl_deflated,value_usd,channel_original,
                                channel_landscape,instrument_original,instrument_landscape,sector_original,sector_landscape,
                                subsector_original,activity_landscape,subactivity_landscape,climate_component,rio_marker,
                                beneficiary_original,beneficiary_landscape,beneficiary_public_private,localization_original,region,
                                uf,municipality)


library(xlsx)
base_select_deflator %>% write_rds("A:\\projects\\landuse_br2024\\siop\\preview_data\\Pack_Siop_Analises\\Siop_21_23_TabelaRelacionalANTIGA.rds")


```

```{r Criação do SIOP expansao com atualizacao da tabela relacional}
library(tidyverse)
library(stringi)
library(readxl)
library(xlsx)


siop_tratado <- read_rds("A:\\projects\\landuse_br2024\\siop\\Clean_Data\\Siop_Tratado_2015_2023_05_24.rds") #258.437 registros
#Tabelas Relacionais
grupo_despesa <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="grupo_despesa")

channel_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="channel_landscape")

sector_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="sector_landscape")
sector_landscape <- sector_landscape %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des_orig,"Latin-ASCII"))))
sector_landscape <- sector_landscape%>%select(acao_des_limpa,sector_landscape)
sector_landscape <- sector_landscape %>% distinct(acao_des_limpa,.keep_all = TRUE) 

beneficiary_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="beneficiary_landscape")
beneficiary_landscape <- beneficiary_landscape%>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
beneficiary_landscape[duplicated(beneficiary_landscape$acao_des_limpa),] %>% view
beneficiary_landscape <- beneficiary_landscape %>% distinct(acao_des_limpa,.keep_all = TRUE)
beneficiary_landscape <- beneficiary_landscape %>% select(acao_des_limpa,beneficiary_landscape,Fonte)

####################################################
source_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="source_landscape")

source_landscape <- source_landscape%>%mutate(source_original = str_trim(str_to_lower(stri_trans_general(source_original,"Latin-ASCII"))))

instrument_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="instrument_landscape")

climate_use <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="climate_use")
climate_use <- climate_use %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
climate_use<-climate_use %>% distinct(acao_des_limpa,.keep_all = TRUE)



acao_plan_orc_count <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx",sheet = "acao_plan_orc_filter")
acao_plan_orc_count_unique <- acao_plan_orc_count %>% mutate(plano_orc_clean = str_trim(str_to_lower(stri_trans_general(plano_orc_clean,"Latin-ASCII")),side="both")) 
acao_plan_orc_count_unique[duplicated(acao_plan_orc_count_unique$plano_orc_clean),] %>% view
acao_plan_orc_count_unique<- acao_plan_orc_count_unique %>% distinct(plano_orc_clean,.keep_all = TRUE)


# Filtrando as observações que nao pagaram nada e filtro para ano
siop_tratado_ano <- siop_tratado %>% filter(Pago != 0)
siop_tratado_ano <- siop_tratado_ano%>%  filter(Ano >= 2021 & Ano <= 2023) 


# 2.1 Filter Grupo Despesa
grupo_despesa %>% filter(select != 1) %>% select(grupo_despesa) %>% as.vector()
siop_tratado_ano <- siop_tratado_ano %>% filter(grupo_de_despesa != "juros e encargos da divida" & grupo_de_despesa!= "amortizacao da divida" & grupo_de_despesa != "reserva de contingencia") #48.552 registros

# 2.3 Filtro de unidade orçamentária baseado na sheet channel landscape:
siop_tratado_unidade_orcamentaria <- siop_tratado_ano %>% inner_join(channel_landscape %>% filter(!is.na(und_orc)) %>% select(und_orc)%>% unique, by= "und_orc") 
channel_landscape %>% filter(!is.na(und_orc)) %>% select(und_orc) %>% anti_join(siop_tratado_ano, by= "und_orc") %>% view

# Pelo anti Join podemos ver que a unidade orçamentaria secretaria especial de agricultura familiar e do desenvolvimento agrario
# nao existe para os anos de 21 até 2023

# 2.3 Criando o primeiro Remainder:
df_remainder_SIOP1 <- siop_tratado_ano %>% anti_join(siop_tratado_unidade_orcamentaria %>% select(und_orc )%>% unique, by= "und_orc")

#df_remainder_SIOP1 %>% select(und_orc) %>% unique  %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\UnidadesOrcamentarias_2021_2023_Fora.xlsx")

#3.1 Seleção Setorial: É baseado nas ações - Dando Left join para explorar
siop_tratado_unidade_orcamentaria_acao <- siop_tratado_unidade_orcamentaria %>% left_join(sector_landscape %>% select(acao_des_limpa,Fonte),by = c("acao" = "acao_des_limpa")) 
sector_landscape%>% select(acao_des_limpa,Fonte) %>% anti_join(siop_tratado_unidade_orcamentaria,by =c( "acao_des_limpa" ="acao" ) ) %>% view
#siop_tratado_unidade_orcamentaria_acao %>% filter(is.na(Fonte.y)) %>% select(Fonte.y,acao,plano_orc,orgao_orc) %>% unique %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\ObservacoeSemMatch_Acao_PosAtualizacao.xlsx")

# Tivemos ações da tabela relacional que nao tiveram match pois essas ações para os anos de 21 ate 23 tiveram valor pago de ZERO ou Acoes que nao existem
# para os anos em questao
# Esta explicacao encontra-se na pasta ExploracoesDados
#3.1 Criando o Remainder 2
df_remainder_siop2 <- siop_tratado_unidade_orcamentaria %>% anti_join(siop_tratado_unidade_orcamentaria_acao %>% select(acao),by = "acao" )
#df_remainder_siop2 %>% select(acao,plano_orc,und_orc) %>% unique %>%  write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\Acoes_2021_2023_Fora_POSATUALIZACAO.xlsx")


#3.1 Seleção Setorial: É baseado nas ações - Dando Inner_join
siop_tratado_unidade_orcamentaria_acao <- siop_tratado_unidade_orcamentaria %>% inner_join(sector_landscape %>% select(acao_des_limpa,Fonte),by = c("acao" = "acao_des_limpa")) 
sector_landscape%>% select(acao_des_limpa,Fonte) %>% anti_join(siop_tratado_unidade_orcamentaria,by =c( "acao_des_limpa" ="acao" ) ) %>% view


# 3.2: Fitro de Planos Orcamentários - Dando Left_joni para explorar
siop_tratado_unidade_orcamentaria_acao_plano_orc <- siop_tratado_unidade_orcamentaria_acao  %>% left_join(acao_plan_orc_count_unique,by = c("plano_orc"="plano_orc_clean")) 
siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(is.na(Fonte.y)) %>% view#TODOS OS PLANOS TIVERAM MATCH
#acao_plan_orc_count_unique %>% anti_join(siop_tratado_unidade_orcamentaria_acao,by = c("plano_orc_clean" = "plano_orc")) %>% unique %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\Planos_orcDeForaFiltro3.2_POSATUALIZACAO.xlsx")

# 3.2: Fitro de Planos Orcamentários - Dando InnerJoin 
siop_tratado_unidade_orcamentaria_acao_plano_orc <- siop_tratado_unidade_orcamentaria_acao  %>% inner_join(acao_plan_orc_count_unique,by = c("plano_orc"="plano_orc_clean")) 
siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(is.na(Fonte.y)) %>% view#TODOS OS PLANOS TIVERAM MATCH
# 3.2: Criando o Remainder Tres:
df_remainder_siop3 <- siop_tratado_unidade_orcamentaria_acao%>% anti_join(siop_tratado_unidade_orcamentaria_acao_plano_orc,by = "plano_orc")

#df_remainder_siop3 %>% select(plano_orc,acao,und_orc) %>% unique %>%  write.xlsx("A:\\projects\\landuse_br2024\\siop\\ExploracoesDados\\Planos_orc_2021_2023_POSATUALIZACAO_Fora.xlsx")
df_remainder_siop3 %>% select(plano_orc,acao,und_orc) %>% unique %>% view

siop_tratado_unidade_orcamentaria_acao_plano_orc$Pago %>% sum
52.465.588.665
41.148.498.642

######################################################################################
acao_plan_orc_count_unique %>% anti_join(siop_tratado_unidade_orcamentaria_acao_plano_orc,by = c("plano_orc_clean"="plano_orc")) %>% view 

adm_unidades_filter <- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
  filter(plano_orc == "administracao da sede"| plano_orc == "administracao das unidades regionais"| plano_orc=="administracao das unidades regionais - regra de ouro" |plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro" | plano_orc == "capacitacao de servidores publicos federais do ibama" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim" |
           plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro" | plano_orc == "coronavirus (covid-19)" |
           plano_orc == "educacao ambiental" |plano_orc == "emenda individual"|
           plano_orc == "gestao administrativa da politica contra as mudancas do clima e de promocao da qualidade ambiental"|plano_orc == "gestao administrativa da politica da biodiversidade"|
           plano_orc == "gestao administrativa da politica das mudancas do clima e de florestas"|
           plano_orc == "gestao administrativa da politica de articulacao e cidadania ambiental"|
           plano_orc == "gestao administrativa da politica de desenvolvimento rural e extrativismo"|
           plano_orc == "gestao administrativa da politica de meio ambiente"|
           plano_orc == "gestao administrativa da politica de recursos hidricos e de qualidade ambiental"|
           plano_orc == "gestao administrativa da politica de relacoes internacionais"|
           plano_orc=="gestao administrativa da politica florestal e da biodiversidade"|
           plano_orc == "gestao administrativa da politica residuos solidos, ambientes urbanos e recursos hidricos"|
           plano_orc == "gestao de politicas de meio ambiente"|
           plano_orc == "manutencao e adaptacao de imoveis"|
           plano_orc == "manutencao e adaptacao de imoveis - regra de ouro"|
           plano_orc == "manutencao e modernizacao da infraestrutura fisica da sede e das unidades descentralizadas"|
           plano_orc == "modernizacao da estrutura de informatica do ibama"|
           plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente"|
           plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente - regra de ouro"|
           plano_orc == "outras despesas administrativas"|
           plano_orc == "outras despesas administrativas - regra de ouro"|
           plano_orc == "reuniao dos comites regionais"|
           plano_orc == "tecnologia da informacao"|
           plano_orc == "tecnologia da informacao - regra de ouro") # Esta de acordo com o Ajuste 1




resto <- siop_tratado_unidade_orcamentaria_acao_plano_orc%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo
folha_pagamento <- resto %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                                      acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                                      acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                                      acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                                      acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                                      acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                                      acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                                      acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                                      acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                      acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais")
# Aqui entra o Ajuste 2 e 3
folha_pagamento_certo <- folha_pagamento %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                                                       und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                                                       und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                                                       und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                                                                                                                                  plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                                                                                                                                                  plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "auxilio-alimentacao de civis"|plano_orc == "auxilio-transporte - civis"|
                                                                                                                                                  plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio"|
                                                                                                                                                  plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas - regra de ouro"|
                                                                                                                                                  plano_orc == "ativos civis da uniao"|
                                                                                                                                                  plano_orc == "auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "auxilio-transporte de civis"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "regra de ouro: auxilio-alimentacao de civis"|
                                                                                                                                                  plano_orc == "regra de ouro: auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|plano_orc == "pagamento de pessoal ativo da uniao"|plano_orc == "ativos civis da uniao"|plano_orc == "pessoal ativo da uniao")



resto2 <- resto %>% anti_join(folha_pagamento)
data_siop_final <- bind_rows(adm_unidades_filter,resto2,folha_pagamento_certo)
data_siop_final$Pago %>% sum
#Valor sem rio_marker 23.549.526.033  


ficou_fora_landscape<- siop_tratado_unidade_orcamentaria_acao_plano_orc %>% anti_join(data_siop_final)
restante <- ficou_fora_landscape %>% filter((acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa")|
                                              (acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa - regra de ouro")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpa")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe - regra de ouro"))

data_siop_final2 <- rbind(restante,data_siop_final)

# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final2%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 
  mutate(value_original_currency = Pago,
         original_currency = "BRL",
         channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>%
  mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 


# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 
#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 


# Aplicacao Rio Marker
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2_metodologiaPadrao$value_original_currency %>% sum #23.562.480.565
data_siop_final_landscape2_metodologiaPadrao %>% select(sector_landscape) %>% unique %>% print
# Pequena alteração nas classes dos dados para padronizar e Ajustar sectors faltantes
data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2_metodologiaPadrao %>% mutate(channel_landscape = case_when(channel_landscape == "Civil society organizations" ~ "Civil society organization",
                                                                                      channel_landscape == "Financial Institutions"  ~"Financial Institution",
                                                                                      .default = channel_landscape),
                                                        origin_private_public = case_when(origin_private_public == "Other"~"Others",
                                                                                          .default = origin_private_public),
                                                        origin_domestic_international = case_when(origin_domestic_international == "Domestic" ~"National",
                                                                                                  .default =origin_domestic_international )) 



data_siop_final_landscape2_metodologiaPadrao <- data_siop_final_landscape2_metodologiaPadrao %>% mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "servico florestal brasileiro - sfb",
                                                                                   true = "Forest",false = sector_landscape)) %>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "ministerio da ciencia, tecnologia e inovacao - administracao direta",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "fundacao nacional do indio - funai",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "ministerio do meio ambiente e mudanca do clima - administracao direta",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto chico mendes de conservacao da biodiversidade",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "apoio ao desenvolvimento de agricultura de baixa emissao de carbono - abc" & und_orc == "ministerio da agricultura e pecuaria - administracao direta",
                                    true = "Crop",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao das medidas de ordenamento do uso de recursos pesqueiros" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Cattle",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao de periculosidade e controle de produtos, substancias quimicas e residuos perigosos" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao dos estoques e do potencial sustentavel dos recursos pesqueiros" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "controle ambiental de produtos, substancias, residuos e atividades potencialmente poluidoras" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do veiculo lancador de microssatelites vlm-1",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do satelite sino-brasileiro cbers-4a",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento de satelites cientificos",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do satelite sino-brasileiro cbers-4a - regra de ouro",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento dos satelites da serie amazonia",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de foguetes suborbitais e de veiculos lancadores de satelites" & und_orc == "agencia espacial brasileira",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de foguetes suborbitais e de veiculos lancadores de satelites, com a infraestrutura associada" & und_orc == "agencia espacial brasileira",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de satelites" & plano_orc == "desenvolvimento dos satelites da serie amazonia",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de satelites" & plano_orc == "desenvolvimento dos satelites sino-brasileiros cbers-4",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "monitoramento hidroambiental nos reservatorios do dnocs" & und_orc == "departamento nacional de obras contra as secas - dnocs",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "monitoramento, avaliacao e controle de substancias, produtos quimicos e biologicos e de atividades potencialmente poluidoras e utilizadoras de recursos ambientais" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
mutate(sector_landscape = if_else(acao == "pesquisa e desenvolvimento no setor aeroespacial" & und_orc == "comando da aeronautica",
                                  true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "pesquisa e desenvolvimento no setor aeroespacial" & und_orc == "fundo aeronautico",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "regulacao e fiscalizacao dos usos de recursos hidricos, dos servicos de irrigacao e aducao de agua bruta e da seguranca de barragens" & und_orc == "agencia nacional de aguas e saneamento basico - ana",
                                    true = "Multi-sector",false = sector_landscape))  %>% 
  mutate(sector_landscape=case_when(sector_landscape=="Agriculture" ~"Crop",
                                    .default = sector_landscape))
  


data_siop_final_landscape2_metodologiaPadrao_final<- data_siop_final_landscape2_metodologiaPadrao %>% left_join(beneficiary_landscape %>% distinct(acao_des_limpa,.keep_all = T) ,by=c("acao"="acao_des_limpa")) %>% 
  mutate(beneficiary_landscape = case_when(acao == "regularizacao da estrutura fundiaria na area de abrangencia da lei 11.952, de 2009"~"Smallholders",
                                           acao == "desenvolvimento economico e social dos produtores rurais"~"Rural Producers",
                                           acao == "abastecimento publico de agua em comunidades ribeirinhas dos rios sao francisco, do parnaiba, do itapecuru e do mearim. - agua para todos"~"Indigenous Peoples, Traditional Populations and Other Local Communities",
                                           acao == "manutencao de contrato de gestao com organizacoes sociais (lei nº 9.637, de 15 de maio de 1998)"~"Not Specified",
                                           acao == "gestao ambientalmente adequada de substancias quimicas"~"Not Specified",
                                           .default = beneficiary_landscape)) %>% 
  mutate(beneficiary_original = "-",
         beneficiary_public_private="-",
         localization_original = localizador,region = regiao,uf = uf,municipality=municipio,subactivity_landscape="-")
  
  


data_siop_final_landscape2_metodologiaPadrao_final$value_original_currency %>% sum
23.562.480.565
#Fazendo Deflacao
ibge_ipca <- read_excel("A:\\macro\\IPCA\\cleanData/ipca_ibge_cl.xlsx")
ibge_ipca <- ibge_ipca %>% 
  dplyr::mutate(variacao_doze_meses = suppressWarnings(as.numeric(variacao_doze_meses)))
deflator_automatico <- function(ano_ini, ano_fim, anos, base) {
  
  # Defina o seu projeto no Google Cloud, é importante criar o projeto e colar o id no "set_billing_id". Fora isso, nao funcionarah
  # Existe um bug no datalake da Base dos Dados que não permite o download direto.
  # set_billing_id("scenic-notch-360215")
  # 
  # # criacao do data frame direto da base de dados
  # serie_basedosdados <- basedosdados::bdplyr("br_ibge_ipca.mes_brasil") %>% bd_collect()
  
  serie_basedosdados <- base
  
  # selecao e filtros de valores de interesse ao calculo, queremos sempre a variacao anual, por isso o mes == 12
  serie_filtrada <- serie_basedosdados %>% 
    select(ano, mes, variacao_doze_meses) %>% 
    dplyr::filter(mes == 12,ano >= ano_ini & ano <= ano_fim ) %>% 
    dplyr::arrange(desc(ano))
  
  indice = 1
  
  #criacao do data frame para o deflator
  for (l in anos) {
    # chamei novamente a base feita pela funcao do api, pois a base precisa ser percorrida ano a ano e
    # se nao criarmos essa tabela, a tabela a ser percorrida novamente terá sempre o ano inicial como observacao
    tabela <- serie_filtrada 
    
    tabela <- tabela %>% 
      dplyr::filter(ano == l)
    
    if (l == ano_fim) {
      tabela <- tabela %>%  dplyr::mutate(deflator = indice)
      tabela_final <- tabela
      indice_ano_anterior = indice * (1+ (tabela$variacao_doze_meses/100))
    } else {
      tabela <- tabela %>% dplyr::mutate(deflator = indice_ano_anterior)
      
      tabela_final <- rbind(tabela_final, tabela)
      indice_ano_anterior = indice_ano_anterior * (1 + (tabela$variacao_doze_meses/100))
    }
  }
  tabela_final <- tabela_final %>% 
    select(ano, deflator) %>%
    dplyr::rename(year = ano) %>% 
    dplyr::arrange(year)
  return(tabela_final)
}

ano_ini = 2015
ano_fim = 2023
anos = seq(ano_fim,ano_ini, -1)
teste <- deflator_automatico(ano_ini, ano_fim, anos,ibge_ipca)
base_select_deflator <- data_siop_final_landscape2_metodologiaPadrao_final %>% 
  left_join(teste, by= "year")%>%
  dplyr::mutate(value_brl_deflated = value_original_currency * deflator)
base_select_deflator$value_brl_deflated %>% sum
# Fazendo a dolarizacao
coleta_dados_sgs = function(series,datainicial="01/01/2012", datafinal = format(Sys.time(), "%d/%m/%Y")){
  #Argumentos: vetor de séries, datainicial que pode ser manualmente alterada e datafinal que automaticamente usa a data de hoje
  #Cria estrutura de repetição para percorrer vetor com códigos de séries e depois juntar todas em um único dataframe
  for (i in 1:length(series)){
    dados = read.csv(url(paste("http://api.bcb.gov.br/dados/serie/bcdata.sgs.",series[i],"/dados?formato=csv&dataInicial=",datainicial,"&dataFinal=",datafinal,sep="")),sep=";")
    dados[,-1] = as.numeric(gsub(",",".",dados[,-1])) #As colunas do dataframe em objetos numéricos exceto a da data
    nome_coluna = series[i] #Nomeia cada coluna do dataframe com o código da série
    colnames(dados) = c('data', nome_coluna)
    nome_arquivo = paste("dados", i, sep = "") #Nomeia os vários arquivos intermediários que são criados com cada série
    assign(nome_arquivo, dados)
    
    if(i==1)
      base = dados1 #Primeira repetição cria o dataframe
    else
      base = merge(base, dados, by = "data", all = T) #Demais repetições agregam colunas ao dataframe criado
    print(paste(i, length(series), sep = '/')) #Printa o progresso da repetição
  }
  
  base$data = as.Date(base$data, "%d/%m/%Y")
  base$ano = as.integer(format(base$data,"%Y"))#Transforma coluna de data no formato de data
  base = base[order(base$data),] #Ordena o dataframe de acordo com a data
  
  base <- base %>% select(ano, `3694`)
  base <- base %>% dplyr::rename(c(year = ano, cambio = `3694`))
  return(base)
}
cambio_sgs = coleta_dados_sgs(3694) 
tabela_cambio <-cambio_sgs %>% 
  dplyr::filter(year >= 2015 & year <= 2023)

base_select_deflator = base_select_deflator %>% 
  left_join(tabela_cambio,by='year') %>% 
  dplyr::mutate(value_usd = value_brl_deflated/cambio)

# Finalizando e salvando
base_select_deflator<- base_select_deflator %>% select(id_original,data_source,year,project_name,project_description,source_original,
                                source_finance_landscape,origin_domestic_international,origin_private_public,
                                value_original_currency,original_currency,value_brl_deflated,value_usd,channel_original,
                                channel_landscape,instrument_original,instrument_landscape,sector_original,sector_landscape,
                                subsector_original,activity_landscape,subactivity_landscape,climate_component,rio_marker,
                                beneficiary_original,beneficiary_landscape,beneficiary_public_private,localization_original,region,
                                uf,municipality)




```
############################################


```{r Pacotes e Dados}
library(tidyverse)
library(stringi)
library(readxl)
library(xlsx)


siop_tratado <- read_rds("A:\\projects\\landuse_br2024\\siop\\Clean_Data\\Siop_Tratado_2015_2023_05_24.rds") #258.437
```

```{r Leitura tabelas rel antigas}
grupo_despesa_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="grupo_despesa")
channel_landscape_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="channel_landscape")


sector_landscape_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="sector_landscape")
sector_landscape_old <- sector_landscape_old %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des_orig,"Latin-ASCII"))))
sector_landscape_old <- sector_landscape_old %>% distinct(acao_des_limpa,.keep_all = TRUE)
sector_landscape_old <- sector_landscape_old%>%select(acao_des_limpa,sector_landscape)


beneficiary_landscape_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="beneficiary_landscape")
beneficiary_landscape_old <- beneficiary_landscape_old%>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
beneficiary_landscape_old <- beneficiary_landscape_old %>% select(acao_des_limpa,beneficiary_landscape)
source_landscape_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="source_landscape")

source_landscape_old <- source_landscape_old%>%mutate(source_original = str_trim(str_to_lower(stri_trans_general(source_original,"Latin-ASCII"))))

instrument_landscape_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="instrument_landscape")

climate_use_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx", sheet="climate_use")
climate_use_old <- climate_use_old %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))




acao_plan_orc_count_old <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables.xlsx",sheet = "acao_plan_orc_filter")
acao_plan_orc_count_old_unique <- acao_plan_orc_count_old %>% mutate(plano_orc_clean = str_trim(str_to_lower(stri_trans_general(plano_orc_clean,"Latin-ASCII")),side="both")) %>% select(plano_orc_clean)%>%unique
```

```{r Leitura tabela rel atual}
grupo_despesa <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="grupo_despesa")

channel_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="channel_landscape")

sector_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="sector_landscape")
sector_landscape <- sector_landscape %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des_orig,"Latin-ASCII"))))
sector_landscape <- sector_landscape%>%select(acao_des_limpa,sector_landscape)
sector_landscape <- sector_landscape %>% distinct(acao_des_limpa,.keep_all = TRUE) 

beneficiary_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="beneficiary_landscape")
beneficiary_landscape <- beneficiary_landscape%>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
beneficiary_landscape[duplicated(beneficiary_landscape$acao_des_limpa),] %>% view
beneficiary_landscape <- beneficiary_landscape %>% distinct(acao_des_limpa,.keep_all = TRUE)
beneficiary_landscape <- beneficiary_landscape %>% select(acao_des_limpa,beneficiary_landscape,Fonte)

####################################################
source_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="source_landscape")

source_landscape <- source_landscape%>%mutate(source_original = str_trim(str_to_lower(stri_trans_general(source_original,"Latin-ASCII"))))

instrument_landscape <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="instrument_landscape")

climate_use <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx", sheet="climate_use")
climate_use <- climate_use %>% mutate(acao_des_limpa = str_trim(str_to_lower(stri_trans_general(acao_des,"Latin-ASCII"))))
climate_use<-climate_use %>% distinct(acao_des_limpa,.keep_all = TRUE)



acao_plan_orc_count <- read_excel("A:\\projects\\landuse_br2024\\siop\\12_siop_relational_tables - ATUALIZACAO.xlsx",sheet = "acao_plan_orc_filter")
acao_plan_orc_count_unique <- acao_plan_orc_count %>% mutate(plano_orc_clean = str_trim(str_to_lower(stri_trans_general(plano_orc_clean,"Latin-ASCII")),side="both")) 
acao_plan_orc_count_unique[duplicated(acao_plan_orc_count_unique$plano_orc_clean),] %>% view
acao_plan_orc_count_unique<- acao_plan_orc_count_unique %>% distinct(plano_orc_clean,.keep_all = TRUE)
```

```{r Comaprações Old New}

siop_tratado_old = siop_tratado
siop_tratado_new = siop_tratado


# Para old
# Filtrando as observações que nao pagaram nada e filtro para ano
siop_tratado_ano_old <- siop_tratado_old %>% filter(Pago != 0)
siop_tratado_ano_old <- siop_tratado_ano_old%>%  filter(Ano >= 2021 & Ano <= 2023) 
# Para new
siop_tratado_new_ano <- siop_tratado_new %>% filter(Pago != 0)
siop_tratado_new_ano <- siop_tratado_new_ano%>%  filter(Ano >= 2021 & Ano <= 2023) 
siop_tratado_new_ano$Pago %>% sum - siop_tratado_ano_old$Pago %>% sum

################SELECT GRUPO DESPESAS########################
# Para old 
grupo_despesa %>% filter(select != 1) %>% select(grupo_despesa) %>% as.vector()
siop_tratado_ano_old <- siop_tratado_ano_old %>% filter(grupo_de_despesa != "juros e encargos da divida" & grupo_de_despesa!= "amortizacao da divida" & grupo_de_despesa != "reserva de contingencia") #141.998 registros
#Para new
siop_tratado_new_ano<- siop_tratado_new_ano %>% filter(grupo_de_despesa != "juros e encargos da divida" & grupo_de_despesa!= "amortizacao da divida" & grupo_de_despesa != "reserva de contingencia") #141.998 registros
siop_tratado_new_ano$Pago %>% sum - siop_tratado_ano_old$Pago %>% sum


######### SELECT CHANNEL (UNIDADE ORC)################
# Para old
siop_tratado_unidade_orcamentaria_old <- siop_tratado_ano_old %>% inner_join(channel_landscape_old %>% filter(!is.na(und_orc)) %>% select(und_orc)%>% unique, by= "und_orc")
# Para new
siop_tratado_unidade_orcamentaria_new <- siop_tratado_new_ano %>% inner_join(channel_landscape %>% filter(!is.na(und_orc)) %>% select(und_orc)%>% unique, by= "und_orc")
siop_tratado_unidade_orcamentaria_new$Pago %>% sum - siop_tratado_unidade_orcamentaria_old$Pago %>% sum


######################################################### ANALISE SECTOR (ACAO) ######################################
# Para old
siop_tratado_unidade_orcamentaria_acao_old <- siop_tratado_unidade_orcamentaria_old %>% inner_join(sector_landscape_old %>% select(acao_des_limpa),by = c("acao" = "acao_des_limpa")) 

# Para New
siop_tratado_unidade_orcamentaria_acao_new <- siop_tratado_unidade_orcamentaria_new %>% inner_join(sector_landscape %>% select(acao_des_limpa),by = c("acao" = "acao_des_limpa")) 
siop_tratado_unidade_orcamentaria_acao_new$Pago %>% sum - siop_tratado_unidade_orcamentaria_acao_old$Pago %>% sum


# ANALISE DOS VALORES POR UNIDADE ORC

siop_tratado_unidade_orcamentaria_acao_new %>% group_by(und_orc) %>% summarise(PagoSum = sum(Pago)) %>% view
siop_tratado_unidade_orcamentaria_acao_old %>% group_by(und_orc) %>% summarise(PagoSum = sum(Pago))%>% view


siop_tratado_unidade_orcamentaria_acao_new %>% filter(und_orc == "secretaria da comissao interministerial para os recursos do mar")%>% select(und_orc,acao,Pago,Ano) %>% group_by(acao) %>% summarise(pago = sum(Pago)) %>% inner_join(siop_tratado_unidade_orcamentaria_acao_old %>% filter(und_orc == "secretaria da comissao interministerial para os recursos do mar")%>% select(und_orc,acao,Pago,Ano) %>% group_by(acao) %>% summarise(pago = sum(Pago)),by = "acao") 


####################################### ANALISE PLANO ORC #########################################
# Para Old
siop_tratado_unidade_orcamentaria_acao_plano_orc_old <- siop_tratado_unidade_orcamentaria_acao_old  %>% inner_join(acao_plan_orc_count_old_unique,by = c("plano_orc"="plano_orc_clean"))

# Para new
siop_tratado_unidade_orcamentaria_acao_plano_orc_new <- siop_tratado_unidade_orcamentaria_acao_new  %>% inner_join(acao_plan_orc_count_unique,by = c("plano_orc"="plano_orc_clean"))

# ANALISE DOS VALORES
siop_tratado_unidade_orcamentaria_acao_plano_orc_new$Pago %>% sum
siop_tratado_unidade_orcamentaria_acao_plano_orc_old$Pago %>% sum

siop_tratado_unidade_orcamentaria_acao_plano_orc_new %>% group_by(und_orc) %>% summarise(sum(Pago)) %>% view
siop_tratado_unidade_orcamentaria_acao_plano_orc_old%>% group_by(und_orc) %>% summarise(sum(Pago)) %>% view



siop_tratado_unidade_orcamentaria_acao_plano_orc_new %>% filter(und_orc == "servico florestal brasileiro - sfb")%>% select(und_orc,plano_orc,Pago,Ano) %>% group_by(plano_orc) %>% summarise(pago = sum(Pago)) %>% left_join(siop_tratado_unidade_orcamentaria_acao_plano_orc_old %>% filter(und_orc == "servico florestal brasileiro - sfb")%>% select(und_orc,plano_orc,Pago,Ano) %>% group_by(plano_orc) %>% summarise(pago = sum(Pago)),by = "plano_orc") %>% mutate(Diferenca = pago.x - pago.y) %>% view


siop_tratado_unidade_orcamentaria_acao_plano_orc_new %>% filter(und_orc == "ministerio do meio ambiente e mudanca do clima - administracao direta" & plano_orc == "capacitacao de recursos humanos") %>% select(plano_orc,acao,Pago) %>% view

view(siop_tratado_unidade_orcamentaria_acao_plano_orc_old %>% filter(und_orc == "ministerio da integracao e do desenvolvimento regional - administracao direta" & plano_orc == "capacitacao de recursos humanos") %>% select(plano_orc,acao,Pago))
siop_tratado_unidade_orcamentaria_acao_plano_orc_new %>% select(plano_orc) %>% unique %>% view

################################# COMPARAÇÃO DAS EXCEÇÕES ###################################################
siop_tratado_unidade_orcamentaria_acao_plano_orc_new$Pago %>% sum

# Para new
adm_unidades_filter_new <- siop_tratado_unidade_orcamentaria_acao_plano_orc_new %>% filter(acao == "administracao da unidade")  %>% filter(und_orc =="ministerio do meio ambiente e mudanca do clima - administracao direta"|und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" | und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |  und_orc == "servico florestal brasileiro - sfb" | und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj")%>%
  filter(plano_orc == "administracao da sede"| plano_orc == "administracao das unidades regionais"| plano_orc=="administracao das unidades regionais - regra de ouro" |plano_orc=="administracao da unidade" |plano_orc=="administracao da unidade - despesas diversas"|plano_orc=="administracao da unidade - despesas diversas - regra de ouro" | plano_orc == "capacitacao de servidores publicos federais do ibama" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim" |
           plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio" | plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro" | plano_orc == "coronavirus (covid-19)" |
           plano_orc == "educacao ambiental" |plano_orc == "emenda individual"|
           plano_orc == "gestao administrativa da politica contra as mudancas do clima e de promocao da qualidade ambiental"|plano_orc == "gestao administrativa da politica da biodiversidade"|
           plano_orc == "gestao administrativa da politica das mudancas do clima e de florestas"|
           plano_orc == "gestao administrativa da politica de articulacao e cidadania ambiental"|
           plano_orc == "gestao administrativa da politica de desenvolvimento rural e extrativismo"|
           plano_orc == "gestao administrativa da politica de meio ambiente"|
           plano_orc == "gestao administrativa da politica de recursos hidricos e de qualidade ambiental"|
           plano_orc == "gestao administrativa da politica de relacoes internacionais"|
           plano_orc=="gestao administrativa da politica florestal e da biodiversidade"|
           plano_orc == "gestao administrativa da politica residuos solidos, ambientes urbanos e recursos hidricos"|
           plano_orc == "gestao de politicas de meio ambiente"|
           plano_orc == "manutencao e adaptacao de imoveis"|
           plano_orc == "manutencao e adaptacao de imoveis - regra de ouro"|
           plano_orc == "manutencao e modernizacao da infraestrutura fisica da sede e das unidades descentralizadas"|
           plano_orc == "modernizacao da estrutura de informatica do ibama"|
           plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente"|
           plano_orc == "modernizacao da estrutura de informatica do ministerio do meio ambiente - regra de ouro"|
           plano_orc == "outras despesas administrativas"|
           plano_orc == "outras despesas administrativas - regra de ouro"|
           plano_orc == "reuniao dos comites regionais"|
           plano_orc == "tecnologia da informacao"|
           plano_orc == "tecnologia da informacao - regra de ouro") 

resto_new <- siop_tratado_unidade_orcamentaria_acao_plano_orc_new%>% filter(acao != "administracao da unidade")

# Aplicando Ajuste 2 e 3 ao mesmo tempo

folha_pagamento_new <- resto_new %>% filter(acao == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                                      acao == "assistencia pre-escolar aos dependentes dos servidores civis, empregados e militares"|
                                      acao == "auxilio-transporte aos servidores civis, empregados e militares"|
                                      acao == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                                      acao == "beneficios assistenciais decorrentes do auxilio-funeral e natalidade"|
                                      acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|
                                      acao=="ativos civis da uniao"| acao == "pagamento de pessoal ativo da uniao"|
                                      acao == "pessoal ativo da uniao"| acao == "beneficios obrigatorios aos servidores civis, empregados, militares e seus dependentes"|
                                      acao == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                      acao == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais")
# Aqui entra o Ajuste 2 e 3

folha_pagamento_certo_new <- folha_pagamento_new %>% filter( und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama" |
                                                       und_orc == "fundacao nacional do indio - funai" | und_orc == "instituto chico mendes de conservacao da biodiversidade" |
                                                       und_orc == "servico florestal brasileiro - sfb" | und_orc=="ministerio do meio ambiente e mudanca do clima - administracao direta"|
                                                       und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj") %>% filter(plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                                                                                                                                  plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica aos servidores civis, empregados, militares e seus dependentes"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes dos servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "auxilio-alimentacao aos servidores civis, empregados e militares"|
                                                                                                                                                  plano_orc == "auxilio-transporte aos servidores civis, empregados e militares"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia medica e odontologica de civis - complementacao da uniao"|
                                                                                                                                                  plano_orc == "auxilio-alimentacao de civis"|plano_orc == "auxilio-transporte - civis"|
                                                                                                                                                  plano_orc== "ajuda de custo para moradia ou auxilio-moradia a agentes publicos"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - regra de ouro"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area fim"|
                                                                                                                                                  plano_orc == "capacitacao de servidores publicos federais em processo de qualificacao e requalificacao - area meio"|
                                                                                                                                                  plano_orc == "ajuda de custo para moradia ou auxilio-moradia a agentes publicos - despesas diversas - regra de ouro"|
                                                                                                                                                  plano_orc == "ativos civis da uniao"|
                                                                                                                                                  plano_orc == "auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "auxilio-transporte de civis"|
                                                                                                                                                  plano_orc == "regra de ouro: assistencia pre-escolar aos dependentes de servidores civis e de empregados"|
                                                                                                                                                  plano_orc == "regra de ouro: auxilio-alimentacao de civis"|
                                                                                                                                                  plano_orc == "regra de ouro: auxilio-funeral e natalidade de civis"|
                                                                                                                                                  plano_orc == "contribuicao da uniao, de suas autarquias e fundacoes para o custeio do regime de previdencia dos servidores publicos federais"|plano_orc == "pagamento de pessoal ativo da uniao"|plano_orc == "pessoal ativo da uniao" | plano_orc == "auxilio-transporte de civis ativos"|
                                                                                                                                                  plano_orc =="auxilio-alimentacao de civis ativos")



resto2_new <- resto_new %>% anti_join(folha_pagamento_new)


data_siop_final<- bind_rows(adm_unidades_filter_new,folha_pagamento_certo_new,resto2_new) 
data_siop_final$Pago %>% sum

ficou_fora_landscape_new<- siop_tratado_unidade_orcamentaria_acao_plano_orc_new %>% anti_join(data_siop_final)

restante_new <- ficou_fora_landscape_new %>% filter((acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa")|
                                              (acao == "administracao da unidade" & plano_orc == "administracao da unidade - inpa - regra de ouro")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpa")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe")|
                                              (acao == "administracao da unidade" & plano_orc == "capacitacao de recursos humanos no inpe - regra de ouro"))

data_siop_final2 <- rbind(restante_new,data_siop_final)
data_siop_final2$Pago %>% sum
# Inicio da Transformacao para o landscape
data_siop_final_landscape <- data_siop_final2%>%
  mutate(id_original = "-",
         data_source = "siop_painel",
         year = Ano,
         project_name = acao,
         project_description = plano_orc,
         source_original = fonte_recursos) %>% left_join(source_landscape%>%select(fonte_recursos, source_finance_landscape, origin_domestic_international,origin_private_public),
                                                         by = "fonte_recursos") %>% 

mutate(value_original_currency = Pago,original_currency = "BRL",channel_original = str_c(modalidade,und_orc,sep=";")) %>% left_join(channel_landscape %>% select(channel_original,channel_landscape),by = "channel_original") %>%
  mutate(instrument_original = grupo_de_despesa) %>% left_join(instrument_landscape, by ="instrument_original") %>% 
  mutate(sector_original = str_c(funcao,subfuncao,sep = ";")) %>% left_join(sector_landscape, by = c("acao" = "acao_des_limpa")) %>% mutate(subsector_original = programa)

#Filtro Climático
data_siop_final_landscape2 <- data_siop_final_landscape %>% left_join(climate_use %>% select(acao_des_limpa,rio_marker,climate_component ,activity_landscape ),by = c("acao"="acao_des_limpa")) 

# Filtro do Ajuste 5 (FOI APLICADO A AJUSTE 5 POIES ELE ESTA CERTO)
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% mutate(rio_marker=as.numeric(rio_marker)) 
data_siop_final_landscape2 <- data_siop_final_landscape2 %>%
  mutate(rio_marker = case_when(plano_orc == "licenca, avaliacao , registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "licenca, avaliacao, registro e autorizacoes ambientais" ~ 0.4,
                                plano_orc == "rastreio e controle de satelites" ~ 0.4,
                                plano_orc == "recepcao, armazenamento, processamento e distribuicao de dados de satelites"~0.4,
                                plano_orc == "apoio ao desenvolvimento sustentavel das cadeias produtivas agricolas"~0.4,
                                plano_orc == "fomento a indicacao geografica de produtos agropecuarios - ig"~0.4,
                                plano_orc == "funcionamento do conselho nacional de recursos hidricos"~0.4,
                                .default = rio_marker)) 

#Filtro de Ajuste 4 (FOI APLICADO O AJUSETE 4 POIS ELE ESTA CERTO TBM)

data_siop_final_landscape2 <- data_siop_final_landscape2 %>% 
  mutate(rio_marker = case_when(plano_orc=="desenvolvimento dos satelites da serie amazonia"~1,
                                plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro"~1,
                                .default = rio_marker)) 

# Aplicacao Rio Marker
data_siop_final_landscape2 <- data_siop_final_landscape2 %>% mutate(value_original_currency = value_original_currency*rio_marker)
data_siop_final_landscape2$value_original_currency %>% sum #26.810.214.393

# Pequena alteração nas classes dos dados para padronizar e Ajustar sectors faltantes

data_siop_final_landscape2 <- data_siop_final_landscape2 %>% mutate(channel_landscape = case_when(channel_landscape == "Civil society organizations" ~ "Civil society organization",
                                                                                      channel_landscape == "Financial Institutions"  ~"Financial Institution",
                                                                                      .default = channel_landscape),
                                                        origin_private_public = case_when(origin_private_public == "Other"~"Others",
                                                                                          .default = origin_private_public),
                                                        origin_domestic_international = case_when(origin_domestic_international == "Domestic" ~"National",
                                                                                                  .default =origin_domestic_international )) 



data_siop_final_landscape3 <- data_siop_final_landscape2 %>% mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "servico florestal brasileiro - sfb",
                                                                                   true = "Forest",false = sector_landscape)) %>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "ministerio da ciencia, tecnologia e inovacao - administracao direta",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "fundacao nacional do indio - funai",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "ministerio do meio ambiente e mudanca do clima - administracao direta",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto de pesquisas jardim botanico do rio de janeiro - jbrj",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "administracao da unidade" & und_orc == "instituto chico mendes de conservacao da biodiversidade",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "apoio ao desenvolvimento de agricultura de baixa emissao de carbono - abc" & und_orc == "ministerio da agricultura e pecuaria - administracao direta",
                                    true = "Crop",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao das medidas de ordenamento do uso de recursos pesqueiros" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Cattle",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao de periculosidade e controle de produtos, substancias quimicas e residuos perigosos" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "avaliacao dos estoques e do potencial sustentavel dos recursos pesqueiros" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "controle ambiental de produtos, substancias, residuos e atividades potencialmente poluidoras" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do veiculo lancador de microssatelites vlm-1",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do satelite sino-brasileiro cbers-4a",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento de satelites cientificos",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento e lancamento do satelite sino-brasileiro cbers-4a - regra de ouro",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento dos satelites da serie amazonia",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento de sistemas espaciais" & plano_orc == "desenvolvimento dos satelites da serie amazonia - regra de ouro",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de foguetes suborbitais e de veiculos lancadores de satelites" & und_orc == "agencia espacial brasileira",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de foguetes suborbitais e de veiculos lancadores de satelites, com a infraestrutura associada" & und_orc == "agencia espacial brasileira",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de satelites" & plano_orc == "desenvolvimento dos satelites da serie amazonia",
                                    true = "Forest",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "desenvolvimento e lancamento de satelites" & plano_orc == "desenvolvimento dos satelites sino-brasileiros cbers-4",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "monitoramento hidroambiental nos reservatorios do dnocs" & und_orc == "departamento nacional de obras contra as secas - dnocs",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "monitoramento, avaliacao e controle de substancias, produtos quimicos e biologicos e de atividades potencialmente poluidoras e utilizadoras de recursos ambientais" & und_orc == "instituto brasileiro do meio ambiente e dos recursos naturais renovaveis - ibama",
                                    true = "Forest",false = sector_landscape))%>% 
mutate(sector_landscape = if_else(acao == "pesquisa e desenvolvimento no setor aeroespacial" & und_orc == "comando da aeronautica",
                                  true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "pesquisa e desenvolvimento no setor aeroespacial" & und_orc == "fundo aeronautico",
                                    true = "Multi-sector",false = sector_landscape))%>% 
  mutate(sector_landscape = if_else(acao == "regulacao e fiscalizacao dos usos de recursos hidricos, dos servicos de irrigacao e aducao de agua bruta e da seguranca de barragens" & und_orc == "agencia nacional de aguas e saneamento basico - ana",
                                    true = "Multi-sector",false = sector_landscape))  %>% 
  mutate(sector_landscape=case_when(sector_landscape=="Agriculture" ~"Crop",
                                    .default = sector_landscape)) %>% 
  mutate(sector_landscape=if_else(acao == "operacao de sistemas espaciais de observacao da terra" & und_orc == "comando da aeronautica",true= "Multi-sector",false = sector_landscape)) %>% 
  mutate(sector_landscape = if_else(acao == "apoio ao desenvolvimento da producao agropecuaria sustentavel" & und_orc == "ministerio da agricultura e pecuaria - administracao direta",true = "Crop",false = sector_landscape)) %>% 
  mutate(sector_landscape=if_else(acao == "desenvolvimento de sistemas espaciais" & und_orc == "agencia espacial brasileira",true = "Multi-sector",false = sector_landscape))

data_siop_final_landscape3<- data_siop_final_landscape3 %>% mutate(sector_landscape= case_when(sector_landscape=="Multi-Sector" ~ "Multi-sector",
                                                                  .default = sector_landscape))

data_siop_final_landscape3<- data_siop_final_landscape3 %>% left_join(beneficiary_landscape %>% distinct(acao_des_limpa,.keep_all = T) %>% select(acao_des_limpa,beneficiary_landscape) ,by=c("acao"="acao_des_limpa")) %>% 
  mutate(beneficiary_landscape = case_when(acao == "regularizacao da estrutura fundiaria na area de abrangencia da lei 11.952, de 2009"~"Smallholders",
                                           acao == "desenvolvimento economico e social dos produtores rurais"~"Rural Producers",
                                           acao == "abastecimento publico de agua em comunidades ribeirinhas dos rios sao francisco, do parnaiba, do itapecuru e do mearim. - agua para todos"~"Indigenous Peoples, Traditional Populations and Other Local Communities",
                                           acao == "manutencao de contrato de gestao com organizacoes sociais (lei nº 9.637, de 15 de maio de 1998)"~"Not Specified",
                                           acao == "gestao ambientalmente adequada de substancias quimicas"~"Not Specified",
                                           .default = beneficiary_landscape)) %>% 
  mutate(beneficiary_original = "-",
         beneficiary_public_private="-",
         localization_original = localizador,region = regiao,uf = uf,municipality=municipio,subactivity_landscape="-")
  
  


data_siop_final_landscape3$value_original_currency %>% sum #26.810.214.393

ibge_ipca <- read_excel("A:\\macro\\IPCA\\cleanData/ipca_ibge_cl.xlsx")
ibge_ipca <- ibge_ipca %>% 
  dplyr::mutate(variacao_doze_meses = suppressWarnings(as.numeric(variacao_doze_meses)))
deflator_automatico <- function(ano_ini, ano_fim, anos, base) {
  

  
  serie_basedosdados <- base
  
  # selecao e filtros de valores de interesse ao calculo, queremos sempre a variacao anual, por isso o mes == 12
  serie_filtrada <- serie_basedosdados %>% 
    select(ano, mes, variacao_doze_meses) %>% 
    dplyr::filter(mes == 12,ano >= ano_ini & ano <= ano_fim ) %>% 
    dplyr::arrange(desc(ano))
  
  indice = 1
  
  #criacao do data frame para o deflator
  for (l in anos) {
    # chamei novamente a base feita pela funcao do api, pois a base precisa ser percorrida ano a ano e
    # se nao criarmos essa tabela, a tabela a ser percorrida novamente terá sempre o ano inicial como observacao
    tabela <- serie_filtrada 
    
    tabela <- tabela %>% 
      dplyr::filter(ano == l)
    
    if (l == ano_fim) {
      tabela <- tabela %>%  dplyr::mutate(deflator = indice)
      tabela_final <- tabela
      indice_ano_anterior = indice * (1+ (tabela$variacao_doze_meses/100))
    } else {
      tabela <- tabela %>% dplyr::mutate(deflator = indice_ano_anterior)
      
      tabela_final <- rbind(tabela_final, tabela)
      indice_ano_anterior = indice_ano_anterior * (1 + (tabela$variacao_doze_meses/100))
    }
  }
  tabela_final <- tabela_final %>% 
    select(ano, deflator) %>%
    dplyr::rename(year = ano) %>% 
    dplyr::arrange(year)
  return(tabela_final)
}

ano_ini = 2015
ano_fim = 2023
anos = seq(ano_fim,ano_ini, -1)
teste <- deflator_automatico(ano_ini, ano_fim, anos,ibge_ipca)
base_select_deflator <- data_siop_final_landscape3 %>% 
  left_join(teste, by= "year")%>%
  dplyr::mutate(value_brl_deflated = value_original_currency * deflator)
base_select_deflator$value_brl_deflated %>% sum #27.736.908.972
# Fazendo a dolarizacao
coleta_dados_sgs = function(series,datainicial="01/01/2012", datafinal = format(Sys.time(), "%d/%m/%Y")){
  #Argumentos: vetor de séries, datainicial que pode ser manualmente alterada e datafinal que automaticamente usa a data de hoje
  #Cria estrutura de repetição para percorrer vetor com códigos de séries e depois juntar todas em um único dataframe
  for (i in 1:length(series)){
    dados = read.csv(url(paste("http://api.bcb.gov.br/dados/serie/bcdata.sgs.",series[i],"/dados?formato=csv&dataInicial=",datainicial,"&dataFinal=",datafinal,sep="")),sep=";")
    dados[,-1] = as.numeric(gsub(",",".",dados[,-1])) #As colunas do dataframe em objetos numéricos exceto a da data
    nome_coluna = series[i] #Nomeia cada coluna do dataframe com o código da série
    colnames(dados) = c('data', nome_coluna)
    nome_arquivo = paste("dados", i, sep = "") #Nomeia os vários arquivos intermediários que são criados com cada série
    assign(nome_arquivo, dados)
    
    if(i==1)
      base = dados1 #Primeira repetição cria o dataframe
    else
      base = merge(base, dados, by = "data", all = T) #Demais repetições agregam colunas ao dataframe criado
    print(paste(i, length(series), sep = '/')) #Printa o progresso da repetição
  }
  
  base$data = as.Date(base$data, "%d/%m/%Y")
  base$ano = as.integer(format(base$data,"%Y"))#Transforma coluna de data no formato de data
  base = base[order(base$data),] #Ordena o dataframe de acordo com a data
  
  base <- base %>% select(ano, `3694`)
  base <- base %>% dplyr::rename(c(year = ano, cambio = `3694`))
  return(base)
}
cambio_sgs = coleta_dados_sgs(3694) 
tabela_cambio <-cambio_sgs %>% 
  dplyr::filter(year >= 2015 & year <= 2023)

base_select_deflator = base_select_deflator %>% 
  left_join(tabela_cambio,by='year') %>% 
  dplyr::mutate(value_usd = value_brl_deflated/cambio)

# Finalizando e salvando
base_select_deflator<- base_select_deflator %>% select(id_original,data_source,year,project_name,project_description,source_original,
                                source_finance_landscape,origin_domestic_international,origin_private_public,
                                value_original_currency,original_currency,value_brl_deflated,value_usd,channel_original,
                                channel_landscape,instrument_original,instrument_landscape,sector_original,sector_landscape,
                                subsector_original,activity_landscape,subactivity_landscape,climate_component,rio_marker,
                                beneficiary_original,beneficiary_landscape,beneficiary_public_private,localization_original,region,
                                uf,municipality)
base_select_deflator

##############
metodoantigo <- read_rds("A:\\projects\\landuse_br2024\\siop\\preview_data\\Pack_Siop_Analises\\Siop_21_23_TabelaRelacionalANTIGA.rds")

atualizado <- read_rds("A:\\projects\\landuse_br2024\\siop\\preview_data\\Pack_Siop_Analises\\Siop_Expansao_Ver1_25052024_TabelaRelacionalATUALIZADA.rds")

atualizado %>% group_by(project_name) %>% summarise(PAGS=sum(value_original_currency)) %>% view
metodoantigo %>% group_by(project_name) %>% summarise(PAGS=sum(value_original_currency)) %>% view
```

```{r Lendo o landscape do ano passado e deflacionando}
library(tidyverse)
antigo <- read_rds("A:\\projects\\brlanduse_landscape102023\\output_final\\base_landscape_final_20052024_reviewed.rds")
siop_antigo <- antigo %>% filter(data_source == "siop_painel")
siop_antigo<- siop_antigo %>% mutate(rio_marker = as.numeric(rio_marker))
base <- Siop_Expansao_Ver3_26052024 %>% bind_rows(siop_antigo)





base_select_deflator2 <- base %>% 
  left_join(teste, by= "year")%>%
  dplyr::mutate(value_brl_deflated = value_original_currency * deflator)

base_select_deflator = base_select_deflator2 %>% 
  left_join(tabela_cambio,by='year') %>% 
  dplyr::mutate(value_usd = value_brl_deflated/cambio)






base_select_deflator %>% select(-cambio,-deflator) %>% write.xlsx("A:\\projects\\landuse_br2024\\siop\\preview_data\\Pack_Siop_Analises\\Dados Gerados\\SIOP_2015_2023_deflacionado_VERSAO2.xlsx")
library(xlsx)
base_select_deflator %>% select(-cambio,-deflator) %>% write_rds("A:\\projects\\landuse_br2024\\siop\\preview_data\\Pack_Siop_Analises\\Dados Gerados\\SIOP_2015_2023_deflacionado_VERSAO2.rds")
```


